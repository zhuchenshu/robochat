

# 聊天机器人概要设计书 

2018/11/26 



 

## 1  引言

### 1.1 背景

聊天机器人，是一种通过自然语言模拟人类进行对话的程序。近年来，聊天机器人受到了学术界和工业界的广泛关注。微软推出了基于情感计算的聊天机器人小冰，百度推出了用于交互式搜索的聊天机器人小度，进而推动了聊天机器人产品化的发展，且符合国家的科研及产业化发展方向。本项目主要实现一个简易的聊天机器人及其技能开发。

### 1.2 产品信息

产品名称：聊天机器人概要设计书

### 1.3 软件名称

产品名称：聊天机器人

### 1.4 参考资料

1)  参考源码：https://github.com/spring-guides/gs-rest-service
2)  参考网址：https://spring.io/
3)  开发环境与工具：Tomcat服务器、SVN代码管理系统、Chrome浏览器、idea集成开发器。
4)  参考技术资料：《spring实战》





## 2  总体设计 

### 2.1 需求规定

| 一级功能 | 二级功能 | 需求功能描述 |
| --- | --- | --- |
| 前端 | 用户输入query | 用户能够输入query |
|| 请求机器人server| 针对用户输入的query，请求机器人server以获取返回响应|
|| 显示闲聊响应话术结果| 当用户使用闲聊话术进行询问后，机器人server返回的响应能够呈现闲聊响应话术给用户|
|| 显示音乐技能响应结果| 当用户使用使用话术寻求音乐时后，机器人server返回的响应能够呈现音乐的响应结果|
| 　 | 实现类微信对话界面效果 | 实现类似微信对话一样的对话界面 |
| 　 | 自定义技能响应结果 | 当用户使用自定义技能对应话术寻求自定义技能时，机器人server返回的响应能够根据自定义技能进行客制化的响应 |
| 机器人server | 实现与前端通信的能力 | 能够获取前端的请求，并给出响应 |
|| 解读music.pattern文件| 解读music.pattern文件，使用其判断用户的query是否是音乐请求|
|| 请求聊天接口| 如果判断用户的query不属于技能请求，则请求聊天接口，获取聊天对话内容|
|| 请求技能音乐技能server| 能够以技能模版格式，发送音乐请求给技能server|
|| 请求自定义技能server| 能够以技能模版格式，发送自定义请求给技能server|
| 技能server| 响应机器人server音乐技能的请求| 根据机器人server发送的json请求，给出指定json格式的响应|
|| 请求第三方音乐接口| 分析根据机器人server的请求，请求第三方音乐接口，获取音乐的信息|
|| 自定义技能server| 在影视，百科，笑话，...,等任意方面,自选一个技能，参考音乐技能实现，独立配置pattern文件，term字典文件，并实现解析，完成对该技能模块的正常响应|


### 2.2 运行环境 
Java+Tomcat


### 2.3 开发环境

Sublime Text+Eclipse+浏览器
Subvision代码管理系统

### 2.4 设计思想

前后端分离：用户的输入和服务器的返回有前端负责，后端的机器人服务器接收消息并在处理后选择是访问API还是发送请求到技能服务器，技能服务器根据请求内容再向第三方歌曲API请求内容。

### 2.5 系统结构

![在这里插入图片描述](https://img-blog.csdnimg.cn/20190805164020439.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA0MzgzOQ==,size_16,color_FFFFFF,t_70)

### 2.6 处理流程
![在这里插入图片描述](https://img-blog.csdnimg.cn/20190806112638136.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA0MzgzOQ==,size_16,color_FFFFFF,t_70)


### 2.7 运行设计
![在这里插入图片描述](https://img-blog.csdnimg.cn/20190805213044530.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA0MzgzOQ==,size_16,color_FFFFFF,t_70)


### 2.8 模块开发方式说明

| 闲聊模块 | 音乐模块 | 页面设计 |
| -------- | -------- | -------- |
| 新开发   | 新开发   | 新设计   |




## 3  接口设计

### 3.1 软件接口
&emsp;1.前端将请求发送至机器人server请求服务：</BR>

```java
    /**
     * 请求机器人聊天接口
     * @param query 聊天内容
     * @return 返回信息
     * 
     */
    @PostMapping()
    public ChatResponse chat(@RequestParam String query) {}
```
&emsp;2.机器人server解析query判断用户请求（与话术模版进行匹配，匹配成功为技能请求，匹配失败则为闲聊请求）：</BR>

```java
    /**
     * Pattern算法
     * @param query 输入的对话字符串
     * @return 语言理解信息
     * 示例：
     * input ： 我要听刘德华的忘情水
     * output：
     * {
     * "domain": "music",
     * "intent": "Music.search",
     *  "slots": [{
     *      "value": "刘德华",
     *      "name": "Person"
     *        }, {
     *      "value": "忘情水",
     *      "name": "MusicName"
     *    }]
     * }
     */
    private Nlu analysisQuery(String query) {}
```
&emsp;3.机器人server解析出query为闲聊服务请求，将query发送至第三方闲聊接口请求聊天：</br>
```java
ask_chat():
```
&emsp;4.机器人server解析出query为任务式请求（播放音乐），将query发送至技能server对应接口请求技能
```java
/**
 * @Description 将解析结果发送给机器人server
 * @param nlu 解析结果
 */
ask_skill(Nlu nlu):
```
&emsp;5.技能server获取请求中的关键字，根据关键字向第三方接口请求音乐信息：
</br>

```java
/**
 * @Description 根据歌手名和歌名调用第三方接口搜索歌曲
 * @param singer 歌手名
 * @param songName 歌名
 * return 返回Music类
 */
Music ask_music(String singer, String songName):
```

前台接口格式实例文档

输入：

```json
{
  "query":"你好"
}
```

输出：

```json
{
     "header": {
         "skillId": 1,
         "skillName": "music",
         "code": 0,
         "message": "正常"
     },
     "payload": {
         "text": "主人，我已经为找到刘德华的忘情水啦",
         "music": {
             "code": 200,
             "data": {
                 "songs": [
                     {
                         "id": "110740",
                         "name": "忘情水(Live)",
                         "al": {
                             "name": "爱你一万年 99演唱会",
                             "picUrl": "http://p2.music.126.net/LRWWw0_d0wZWWicIKQIkfA==/65970697667341.jpg"
                         }
                     }
                 ]
             },
             "playUrl": "https://v1.itooi.cn/netease/url?id=110740&quality=flac"
         }
     },
     "nlu": {
         "domain": "music",
         "intent": "Music.search",
         "slots": [
             {
                 "name": "Person",
                 "value": "刘德华"
             },
             {
                 "name": "MusicName",
                 "value": "忘情水"
             }
         ]
     }
 }
 ```

备注： 
|code| message  | 备注 |
|--|--| -- |
| 0 | 正常 | 正常  |
| 1 | 音乐正忙，请稍后再试| 音乐接口出错|
| 2 | 闲聊正忙，请稍后再试| 闲聊接口出错|
| 3 | 你想听，我太高兴了| 找不到该首歌|

输入：

```json
{
  "query":"你好"
}
```

输出：

```json
 {
     "header": {
         "skillId": 0,
         "skillName": "chat",
         "code": 0,
         "message": "正常"
     },
     "payload": {
         "text": "你好啊",
         "music": null
     },
     "nlu": {
         "domain": "chet",
         "intent": null,
         "slots": null
     }
 }
 ```


## 4  属性设计

### 4.1 性能
&emsp; 1.优化query解析算法逻辑以提升性能 </br></br>
&emsp; 2.丰富话术模版数据pattern以提高比对处理的准确性和有效性 </br></br>
&emsp; 3.优化第三方闲聊接口与音乐接口以提高服务请求响应速度 </br>


### 4.2 可靠性
&emsp;1.优化项目时尽量不改变项目原有结构，以保证项目安全 </br></br>
&emsp;2.将服务返回限定在闲聊与技能两者之间，保证返回内容的有效、有意义</br><br>
## 5  系统出错处理

错误类型| 原因|  解决方案
-------- | ----- | ----
机器人闲聊状态下未返回数据| 机器人server与闲聊接口调用失败 | 返回自定义错误状态码 3 以及错误信息提示
机器人机能状态下返回音乐失败|技能server与第三方音乐接口调用失败| 1.算法错误调整Pattern解析算法<br> 2.调用接口失败，返回自定义错误码 1 与失败信息<br> 3.找不到音乐，返回自定义状态码 2 以及提示。
页面显示错误  | 样式冲突 | 调整样式

## 6  系统调试与测试方法 

### 6.1 调试方法

后端：postmen+idea/eclipse 
前端：Chrome浏览器控制台

### 6.2 测试方法
手动测试：编写测试用例进行手动测试
白盒测试：后台编写单元测试进行白盒测试。


### 6.3 自动测试
暂定编写脚本自动测试。
